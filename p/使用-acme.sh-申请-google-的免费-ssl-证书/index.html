<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="上个月 30 日，Google Cloud 在其博客发表文章\u00a0Automate Public Certificates Lifecycle Management via RFC 8555 (ACME)\u00a0发布了测试版的自动化公共 CA 管理程序。 简而言之就是 Google 也开放了类似于 Let’s Encrypt 的免费证书申请。并且和 Google 各项服务使用相同的根证书。 优劣分析 可以设置颁发证书的有效期；（最长 90 天） 支持多域名及通配符；（与 Let’s Encrypt 相同） 仅支持 DNS 验证和文件验证，不支持邮件验证；（与 Let’s Encrypt 相同） 支持 IP 地址，但是仅允许该 IP 地址块的所有者进行验证；（Let’s Encrypt 暂不支持） 不支持 IDN (International Domain Name, 国际化域名，使用 Punycode 进行编码，形如 xn–1.xn–2).（Let’s Encrypt 已经支持） 目前签发的证书，即使选择 ECC 类型，证书链的中级证书也是 RSA 的（Let’s Encrypt 已经支持全链 ECC） ocsp.pki.goog 有国内节点，访客体验还是很不错的。 目前有 DNSSEC CAA 问题，在 DNSPod 添加了 DNSSEC 的用户请暂缓申请 申请方法 申请 GOOGLE 域名 API 登录 google 账号后，进入下面链接"><title>使用 acme.sh 申请 Google 的免费 SSL 证书</title>
<link rel=canonical href=https://blog.taoshuge.eu.org/p/%E4%BD%BF%E7%94%A8-acme.sh-%E7%94%B3%E8%AF%B7-google-%E7%9A%84%E5%85%8D%E8%B4%B9-ssl-%E8%AF%81%E4%B9%A6/><link rel=stylesheet href=/scss/style.min.9b797e718c050a5076d627d63a6f0a4309d678b56f680d16525bda176970af90.css><meta property='og:title' content="使用 acme.sh 申请 Google 的免费 SSL 证书"><meta property='og:description' content="上个月 30 日，Google Cloud 在其博客发表文章\u00a0Automate Public Certificates Lifecycle Management via RFC 8555 (ACME)\u00a0发布了测试版的自动化公共 CA 管理程序。 简而言之就是 Google 也开放了类似于 Let’s Encrypt 的免费证书申请。并且和 Google 各项服务使用相同的根证书。 优劣分析 可以设置颁发证书的有效期；（最长 90 天） 支持多域名及通配符；（与 Let’s Encrypt 相同） 仅支持 DNS 验证和文件验证，不支持邮件验证；（与 Let’s Encrypt 相同） 支持 IP 地址，但是仅允许该 IP 地址块的所有者进行验证；（Let’s Encrypt 暂不支持） 不支持 IDN (International Domain Name, 国际化域名，使用 Punycode 进行编码，形如 xn–1.xn–2).（Let’s Encrypt 已经支持） 目前签发的证书，即使选择 ECC 类型，证书链的中级证书也是 RSA 的（Let’s Encrypt 已经支持全链 ECC） ocsp.pki.goog 有国内节点，访客体验还是很不错的。 目前有 DNSSEC CAA 问题，在 DNSPod 添加了 DNSSEC 的用户请暂缓申请 申请方法 申请 GOOGLE 域名 API 登录 google 账号后，进入下面链接"><meta property='og:url' content='https://blog.taoshuge.eu.org/p/%E4%BD%BF%E7%94%A8-acme.sh-%E7%94%B3%E8%AF%B7-google-%E7%9A%84%E5%85%8D%E8%B4%B9-ssl-%E8%AF%81%E4%B9%A6/'><meta property='og:site_name' content='荒芜'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='ssl'><meta property='article:tag' content='证书'><meta property='article:tag' content='acme.sh'><meta property='article:tag' content='谷歌'><meta property='article:published_time' content='2023-08-28T16:12:32+00:00'><meta property='article:modified_time' content='2024-08-04T14:37:51+00:00'><meta name=twitter:title content="使用 acme.sh 申请 Google 的免费 SSL 证书"><meta name=twitter:description content="上个月 30 日，Google Cloud 在其博客发表文章\u00a0Automate Public Certificates Lifecycle Management via RFC 8555 (ACME)\u00a0发布了测试版的自动化公共 CA 管理程序。 简而言之就是 Google 也开放了类似于 Let’s Encrypt 的免费证书申请。并且和 Google 各项服务使用相同的根证书。 优劣分析 可以设置颁发证书的有效期；（最长 90 天） 支持多域名及通配符；（与 Let’s Encrypt 相同） 仅支持 DNS 验证和文件验证，不支持邮件验证；（与 Let’s Encrypt 相同） 支持 IP 地址，但是仅允许该 IP 地址块的所有者进行验证；（Let’s Encrypt 暂不支持） 不支持 IDN (International Domain Name, 国际化域名，使用 Punycode 进行编码，形如 xn–1.xn–2).（Let’s Encrypt 已经支持） 目前签发的证书，即使选择 ECC 类型，证书链的中级证书也是 RSA 的（Let’s Encrypt 已经支持全链 ECC） ocsp.pki.goog 有国内节点，访客体验还是很不错的。 目前有 DNSSEC CAA 问题，在 DNSPod 添加了 DNSSEC 的用户请暂缓申请 申请方法 申请 GOOGLE 域名 API 登录 google 账号后，进入下面链接"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/lxgwwenkaiscreen.css><link rel=stylesheet href=https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css><style>#scroll-to-top{display:none;position:fixed;bottom:20px;right:30px;z-index:99;font-size:18px;border:none;outline:none;background-color:#555;color:#fff;cursor:pointer;padding:15px;border-radius:4px}#scroll-to-top:hover{background-color:#333}</style><button onclick=topFunction() id=scroll-to-top title="Go to top">Top</button>
<script>window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("scroll-to-top").style.display="block":document.getElementById("scroll-to-top").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=/js/tiaozhuan.js></script><link rel=preconnect href=//sdk.51.la><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:3,hoverDelay:50}</script><script defer src=/js/flying-pages.min.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#优劣分析>优劣分析</a></li></ol></li><li><a href=#申请方法>申请方法</a><ol><li><a href=#申请-google-域名-api>申请 GOOGLE 域名 API</a></li><li><a href=#安装-acmesh>安装 acme.sh</a></li><li><a href=#申请-google-证书>申请 google 证书</a></li><li><a href=#签发证书>签发证书</a></li><li><a href=#查看已证书安装信息>查看已证书安装信息</a></li></ol></li><li><a href=#选择默认-ca>选择默认 CA</a></li><li><a href=#使用-http-验证签发证书>使用 HTTP 验证签发证书</a></li><li><a href=#使用-dns-验证签发证书>使用 DNS 验证签发证书</a><ol><li><a href=#更新证书>更新证书</a></li><li><a href=#更新acmesh>更新acme.sh</a></li><li><a href=#官方文档>官方文档</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%BD%BF%E7%94%A8-acme.sh-%E7%94%B3%E8%AF%B7-google-%E7%9A%84%E5%85%8D%E8%B4%B9-ssl-%E8%AF%81%E4%B9%A6/>使用 acme.sh 申请 Google 的免费 SSL 证书</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-08-28</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 4 分钟</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#9e9e9e" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4L18.5 9.5a2.828 2.828.0 10-4-4L4 16v4"/><path d="M13.5 6.5l4 4"/></svg>
<time class=article-time--reading>字数: 646字</time></div></footer></div></header>   <div class=post-ai><div class=ai-title><i class="fas fa-robot ai-title-icon"></i><div class=ai-title-text>摘要GPT</div></div><div id=ai-explanation class=ai-explanation></div><div class="ai-explanation ai-explanation-content">摘要小助理暂时失联跑路啦……😜</div></div><script src=https://npm.elemecdn.com/typeit@8.7.1/dist/index.umd.js></script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".ai-explanation-content").textContent;new TypeIt("#ai-explanation",{strings:e,speed:10,lifeLike:!0,waitUntilVisible:!0}).go()})</script><section class=article-content><blockquote><p>上个月 30 日，Google Cloud 在其博客发表文章 <a class=link href=https://cuojue.org/go/#aHR0cHM6Ly9jbG91ZC5nb29nbGUuY29tL2Jsb2cvcHJvZHVjdHMvaWRlbnRpdHktc2VjdXJpdHkvYXV0b21hdGUtcHVibGljLWNlcnRpZmljYXRlLWxpZmVjeWNsZS1tYW5hZ2VtZW50LXZpYS0tYWNtZS1jbGllbnQtYXBp target=_blank rel=noopener>Automate Public Certificates Lifecycle Management via RFC 8555 (ACME)</a> 发布了测试版的自动化公共 CA 管理程序。<br>简而言之就是 Google 也开放了类似于 Let’s Encrypt 的免费证书申请。并且和 Google 各项服务使用相同的根证书。</p></blockquote><h3 id=优劣分析>优劣分析</h3><ol><li>可以设置颁发证书的有效期；（<code>最长 90 天</code>）</li><li>支持<code>多域名及通配符</code>；（与 Let’s Encrypt 相同）</li><li>仅<code>支持 DNS 验证和文件验证</code>，不支持邮件验证；（与 Let’s Encrypt 相同）</li><li><code>支持 IP 地址</code>，但是仅允许该 IP 地址块的所有者进行验证；（Let’s Encrypt 暂不支持）</li><li>不支持 IDN (International Domain Name, 国际化域名，使用 Punycode 进行编码，形如 xn–1.xn–2).（Let’s Encrypt 已经支持）</li><li>目前签发的证书，即使选择 <code>ECC</code> 类型，证书链的中级证书也是 RSA 的（Let’s Encrypt 已经支持全链 ECC）</li><li><code>ocsp.pki.goog</code> 有<code>国内节点</code>，访客体验还是很不错的。</li><li>目前有 DNSSEC CAA 问题，在 DNSPod 添加了 DNSSEC 的用户请暂缓申请</li></ol><h2 id=申请方法>申请方法</h2><h3 id=申请-google-域名-api>申请 GOOGLE 域名 API</h3><p>登录 google 账号后，进入下面链接</p><p><a class=link href="https://cloud.google.com/sdk/gcloud/reference/publicca?hl=zh-cn" target=_blank rel=noopener>https://cloud.google.com/sdk/gcloud/reference/publicca?hl=zh-cn</a></p><p>单击<code>右上角</code>的“<code>激活 Cloud Shell</code>”，打开Cloud Shell</p><p><img src=https://imgs.leshans.eu.org/docs/1713300328.png loading=lazy></p><p>然后在在 Cloud Shell 输入</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud publicca external-account-keys create
</span></span></code></pre></div><p>要等待一会才会返回 <code>keyid</code> 和 <code>b64mackey</code>，不行就多输入几次</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Created an external account key
</span></span><span class=line><span class=cl>[b64MacKey: xxxxxxxxxxxxxxxxxxx
</span></span><span class=line><span class=cl>keyId: xxxxxxxxxxxx]
</span></span></code></pre></div><p>保存好keyId和b64MacKey</p><h3 id=安装-acmesh>安装 acme.sh</h3><p>如果已经安装请忽略这步</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://get.acme.sh <span class=p>|</span> sh -s <span class=nv>email</span><span class=o>=</span>你的邮箱
</span></span></code></pre></div><p>或者</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O -  https://get.acme.sh <span class=p>|</span> sh -s <span class=nv>email</span><span class=o>=</span>你的邮箱
</span></span></code></pre></div><p>若后面出现 command not found，则需要手动执行以下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></div><p>Acme.sh 默认生成 Let’s Encrypt R3 证书，我们需要修改一下让它默认生成 google 证书</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server google
</span></span></code></pre></div><h3 id=申请-google-证书>申请 google 证书</h3><p>获取申请 google 证书的资格</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/.acme.sh/acme.sh --register-account --server google \
</span></span><span class=line><span class=cl>    --eab-kid &#34;xxxxx&#34; \
</span></span><span class=line><span class=cl>    --eab-hmac-key &#34;xxxxx&#34;
</span></span></code></pre></div><p><code>eab-kid</code> 为申请到的谷歌 keyId</p><p><code>eab-hmac-key</code> 申请到的 b64MacKey</p><p>注意: <code>API 获取的凭证</code>应该是<code>只能使用一次</code>，重新获取 API 凭证之后可以成功注册（更新：每台服务器都需要单独的凭证注册一次，之后的签发则不再需要）。</p><h3 id=签发证书>签发证书</h3><p><strong>acme.sh</strong> 实现了 <strong>acme</strong> 协议支持的所有验证协议. 一般有两种方式验证: http 和 dns 验证.</p><ol><li>http 方式需要在你的网站根目录下放置一个文件, 来验证你的域名所有权,完成验证. 然后就可以生成证书了.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>acme.sh --issue -d mydomain.com --webroot /home/wwwroot/mydomain.com/
</span></span></code></pre></div><p>只需要<code>指定域名</code>, 例如: mydomain.com 多个可以后面再加 -d <a class=link href=https://www.mydomain.com target=_blank rel=noopener>www.mydomain.com</a></p><p>并指定域名所在的<code>网站根目录</code>, 例如: /home/wwwroot/mydomain.com/</p><p><strong>acme.sh</strong> 会全自动的生成验证文件, 并放到网站的根目录, 然后自动完成验证. 最后会聪明的删除验证文件. 整个过程没有任何副作用.</p><h3 id=查看已证书安装信息>查看已证书安装信息</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --info -d example.com
</span></span></code></pre></div><h2 id=选择默认-ca>选择默认 CA</h2><p>目前 <a class=link href=http://acme.sh/ target=_blank rel=noopener>acme.sh</a> 支持 5 个正式环境 CA，分别是 <a class=link href=https://letsencrypt.org/ target=_blank rel=noopener>Let&rsquo;s Encrypt</a>、<a class=link href=https://www.buypass.com/ target=_blank rel=noopener>Buypass</a>、<a class=link href=https://u.nu/zerossl target=_blank rel=noopener>ZeroSSL</a>、<a class=link href=https://www.ssl.com/ target=_blank rel=noopener>SSL.com</a>和 <a class=link href=https://cloud.google.com/certificate-manager/docs/public-ca-tutorial target=_blank rel=noopener>Google Public CA</a>，默认使用 ZeroSSL，如果需要更换可以使用如下命令：</p><p>切换 Let&rsquo;s Encrypt</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server letsencrypt
</span></span></code></pre></div><p>切换 Buypass</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server buypass
</span></span></code></pre></div><p>切换 ZeroSSL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server zerossl
</span></span></code></pre></div><p>切换 <a class=link href=http://ssl.com/ target=_blank rel=noopener>SSL.com</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server ssl.com
</span></span></code></pre></div><p>切换 Google Public CA</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --set-default-ca --server google
</span></span></code></pre></div><p>如果已有 ZeroSSL 帐号，可以在后台控制面板拿到 API Key，然后执行如下命令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt install jq
</span></span><span class=line><span class=cl>curl -s -X POST <span class=s2>&#34;https://api.zerossl.com/acme/eab-credentials?access_key=你的API_Key&#34;</span> <span class=p>|</span> jq
</span></span></code></pre></div><p>终端会输出如下内容</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;success&#34;: true,
</span></span><span class=line><span class=cl>  &#34;eab_kid&#34;: &#34;kid字符串&#34;,
</span></span><span class=line><span class=cl>  &#34;eab_hmac_key&#34;: &#34;hmac_key字符串&#34;,
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>然后手工添加帐号</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>acme.sh --register-account  --server zerossl \
</span></span><span class=line><span class=cl>        --eab-kid kid字符串  \
</span></span><span class=line><span class=cl>        --eab-hmac-key hmac_key字符串
</span></span></code></pre></div><p>Google Public CA 需要按照<a class=link href=https://cloud.google.com/blog/products/identity-security/automate-public-certificate-lifecycle-management-via--acme-client-api target=_blank rel=noopener>官方博客</a>申请内测，然后获取 Key。</p><p>几个 CA 的简单对比</p><div class=table-wrapper><table><thead><tr><th>功能</th><th>LE</th><th>Buypass</th><th>ZeroSSL</th><th><a class=link href=http://ssl.com/ target=_blank rel=noopener>SSL.com</a></th><th>Google Public CA</th></tr></thead><tbody><tr><td>有效期</td><td>90 天</td><td>180 天</td><td>90 天</td><td>90 天</td><td>90 天</td></tr><tr><td>多域名</td><td>支持</td><td>支持，最多 5 个</td><td>支持</td><td>收费支持</td><td>支持</td></tr><tr><td>泛域名</td><td>支持</td><td>不支持</td><td>支持</td><td>收费支持</td><td>支持</td></tr><tr><td>Rate Limit</td><td>有</td><td>有</td><td>收费无</td><td>未知</td><td>有</td></tr><tr><td>GUI 管理</td><td>否</td><td>否</td><td>有</td><td>有</td><td>无</td></tr><tr><td>ECC 证书链</td><td>否</td><td>否</td><td>有</td><td>未知</td><td>无</td></tr><tr><td>客户支持</td><td>社区</td><td>收费</td><td>收费</td><td>收费</td><td>收费</td></tr></tbody></table></div><p>简单来说，如果没有特殊需求，可以选择 Let&rsquo;s Encrypt，如果服务器在国内，可以选择 ZeroSSL 或 Buypass，如果愿意付费得到更好的服务和保障，可以选择 ZeroSSL 和 <a class=link href=http://ssl.com/ target=_blank rel=noopener>SSL.com</a>，如果面向欧盟用户，可以选择 Buypass 和 ZeroSSL。</p><p><em>注意：经过测试 Google Public CA 的 ACME 验证域名在国内是无法访问的，只有国外服务器才可以申请，申请完成后的证书并无影响。</em></p><h2 id=使用-http-验证签发证书>使用 HTTP 验证签发证书</h2><p>我们以 Let&rsquo;s Encrypt 为例，直接在终端运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --issue -d example.com -w /var/www/letsencrypt
</span></span></code></pre></div><p>如果希望签发 ECC 证书，则运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --issue -d example.com --keylength ec-256 -w /var/www/letsencrypt
</span></span></code></pre></div><p>如果需要多个域名，则运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --issue -d example.com -d example.org -w /var/www/letsencrypt
</span></span></code></pre></div><p>然后就等他执行完，直到出现 <code>Cert success</code> 的提示</p><p><img src=https://r2.leshans.eu.org/2023/08/a94fd19d8971edb593faaa0d65974c6b.webp loading=lazy alt="Pasted image 20230829023310"></p><p>然后我们可以安装证书</p><p>Nginx</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --install-cert -d example.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file       /etc/nginx/ssl/example.com.key  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--fullchain-file /etc/nginx/ssl/example.com.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ca-file        /etc/nginx/ssl/example.com.ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--reloadcmd     <span class=s2>&#34;systemctl restart nginx&#34;</span>
</span></span></code></pre></div><p>对应的 Nginx 配置指定证书文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>ssl_certificate</span> <span class=s>/etc/nginx/ssl/example.com.crt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>ssl_certificate_key</span> <span class=s>/etc/nginx/ssl/example.com.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>ssl_trusted_certificate</span> <span class=s>/etc/nginx/ssl/example.com.ca.crt</span><span class=p>;</span>
</span></span></code></pre></div><p>Apache</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --install-cert -d example.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file       /etc/apache2/ssl/example.com.key  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--fullchain-file /etc/apache2/ssl/example.com.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ca-file        /etc/apache2/ssl/example.com.ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--reloadcmd     <span class=s2>&#34;curl https://ssl-config.mozilla.org/ffdhe2048.txt &gt;&gt; /etc/apache2/ssl/example.com.crt &amp;&amp; systemctl restart apache2&#34;</span>
</span></span></code></pre></div><p>对应的 Apache 配置指定证书文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-apache data-lang=apache><span class=line><span class=cl><span class=nb>SSLCertificateFile</span>      <span class=sx>/etc/apache2/ssl/example.com.crt</span>
</span></span><span class=line><span class=cl><span class=nb>SSLCertificateKeyFile</span>   <span class=sx>/etc/apache2/ssl/example.com.key</span>
</span></span></code></pre></div><p>如果是 ECC 证书，则安装的时候需要带上 <code>--ecc</code> 参数，比如</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --install-cert --ecc -d example.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file       /etc/nginx/ssl/example.com.key  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--fullchain-file /etc/nginx/ssl/example.com.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ca-file        /etc/nginx/ssl/example.com.ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--reloadcmd     <span class=s2>&#34;systemctl restart nginx&#34;</span>
</span></span></code></pre></div><p>注意如果是多个域名，也仅需要在 <code>-d</code> 参数后面指定第一个域名即可。</p><h2 id=使用-dns-验证签发证书>使用 DNS 验证签发证书</h2><p>有时候因为不想暴露一些二级域名，或者希望在多台机器上部署同一个域名的证书，这时候就需要用到 DNS 插件了，<a class=link href=https://github.com/acmesh-official/acme.sh/wiki/dnsapi target=_blank rel=noopener>acme.sh</a> 支持几十种 DNS 插件。</p><p>这里以 Cloudflare 为例，登录 Cloudflare Dash 后在 <a class=link href=https://dash.cloudflare.com/profile/api-tokens target=_blank rel=noopener>API Token</a> 菜单里添加一个 API Token：</p><p><img src=https://r2.leshans.eu.org/2023/08/4fdce737b8b441d513c523e40da9fa90.webp loading=lazy alt="Pasted image 20230829023544"></p><p>然后选择 Edit Zone DNS 的模板</p><p><img src=https://r2.leshans.eu.org/2023/08/a7655914900e328325772afeba21f046.webp loading=lazy alt="Pasted image 20230829023556"></p><p>选择你要编辑的域名，也可以加入你服务器的 IP 作为白名单</p><p><img src=https://r2.leshans.eu.org/2023/08/1594e6dbc1044ea3174cb58e9501c8c7.webp loading=lazy alt="Pasted image 20230829023610"></p><p>完成后会给你一串字符，把他复制下来，需要填入下方的 <code>CF_Token</code> 参数</p><p><img src=https://r2.leshans.eu.org/2023/08/6453b45daabaf41793b6f1baf646f4d1.webp loading=lazy alt="Pasted image 20230829023626"></p><p>然后进入域名的管理页面，在右侧 API 列找到 <code>Account ID</code> 和 <code>Zone ID</code> 并复制</p><p><img src=https://r2.leshans.eu.org/2023/08/4f11c193526c0a26a83fe7c16c314ce1.webp loading=lazy alt="Pasted image 20230829023641"></p><p>接着在终端运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CF_Token</span><span class=o>=</span><span class=s2>&#34;复制下来的 Token&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CF_Account_ID</span><span class=o>=</span><span class=s2>&#34;复制下来的 Account ID&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CF_Zone_ID</span><span class=o>=</span><span class=s2>&#34;复制下来的 Zone ID&#34;</span>
</span></span></code></pre></div><p>然后开启 <a class=link href=http://acme.sh/ target=_blank rel=noopener>acme.sh</a> 的 DNS API 模式申请证书</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --issue --dns dns_cf -d example.com -d *.example.com
</span></span></code></pre></div><p>如果是dns.la:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LA_Id</span><span class=o>=</span><span class=s2>&#34;&lt;appid&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LA_Key</span><span class=o>=</span><span class=s2>&#34;&lt;apikey&gt;&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --issue --dns dns_la -d example.com -d *.example.com
</span></span></code></pre></div><p>安装证书方法同上，另外吐槽下，很多教程会让你用 Cloudflare 的全局 Global API Key，真的是，风险太大了，最后怎么被黑的都不知道 = =</p><p>如果不想使用第三方的 DNS 服务完全可以自建 <a class=link href=https://github.com/joohoi/acme-dns target=_blank rel=noopener>acme-dns</a> 或者 <a class=link href=https://github.com/PowerDNS/pdns target=_blank rel=noopener>PowerDNS</a>，篇幅有限，我们之后再介绍。</p><h3 id=更新证书>更新证书</h3><p>目前证书在 60 天以后会自动更新，您无需进行任何操作。接下来可能会讲这个时间，但是都是自动的，你不用担心。</p><p>请确保 cronjob 正确安装，看起来类似如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>crontab  -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>56 * * * * &#34;/root/.acme.sh&#34;/acme.sh --cron --home &#34;/root/.acme.sh&#34; &gt; /dev/null
</span></span></code></pre></div><h3 id=更新acmesh>更新acme.sh</h3><p>目前由于 acme 协议和 Letscrypt CA 都在关闭的更新，因此 acme.sh 也经常更新以保持同步。</p><p>升级 acme.sh 到最新版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --upgrade
</span></span></code></pre></div><p>如果您不想手动升级，可以开启自动升级：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acme.sh --upgrade --auto-upgrade
</span></span></code></pre></div><p>此后，acme.sh就会自动保持更新了。</p><p>您也可以随时关闭自动更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>acme.sh --upgrade --auto-upgrade  0
</span></span></code></pre></div><h3 id=官方文档>官方文档</h3><p><a class=link href=https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E target=_blank rel=noopener>https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E</a></p><p><a class=link href=https://github.com/acmesh-official/acme.sh/wiki/dnsapi#dns_cf target=_blank rel=noopener>https://github.com/acmesh-official/acme.sh/wiki/dnsapi#dns_cf</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ssl/>Ssl</a>
<a href=/tags/%E8%AF%81%E4%B9%A6/>证书</a>
<a href=/tags/acme.sh/>Acme.sh</a>
<a href=/tags/%E8%B0%B7%E6%AD%8C/>谷歌</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>知识共享许可证 CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-08-04 14:37</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/ssl/><div class=article-details><h2 class=article-title>acme自制脚本快速申请免费证书</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 荒芜<br>🕊️ 发表了291篇文章 ·
总计39.27k字<br>本站已稳定运行
<span id=runningdays class=running-days></span>
<script>function updateRunningTime(){const t=new Date("2023-07-25".replace(/-/g,"/")),n=new Date,e=n-t,s=Math.floor(e/(1e3*60*60*24)),o=Math.floor(e%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(e%(1e3*60*60)/(1e3*60)),a=Math.floor(e%(1e3*60)/1e3),r=`${s} 天 ${o} 小时 ${i} 分 ${a} 秒 🚀`;document.getElementById("runningdays").innerHTML=r}setInterval(updateRunningTime,1e3),updateRunningTime()</script><br></section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/woniu336/hugo-magic target=_blank rel=noopener data-version=3.26.0>hugo-magic</a></b> 由 <a href=https://blog.taoshuge.eu.org/ target=_blank rel=noopener><u>小洋葱</u></a> 魔改 由 Jimmy 设计</section><a target=_blank href=https://gohugo.io/ title="使用 Hugo 构建"><img src=/img/hugo.svg alt>
</a><a target=_blank href=https://github.com/CaiJimmy/hugo-theme-stack title=主题开源项目><img src=/img/github.svg alt>
</a><a target=_blank href=https://vercel.com/ title="部署于 Vercel"><img src=/img/vercel.svg alt>
</a><a target=_blank href=https://umami.is/ title="由 Umami 提供数据分析"><img src=/img/umami.svg alt>
</a><a target=_blank href=https://notbyai.fyi title="Written by Human, Not by AI"><img src=/img/notbyai.png alt="Written by Human, Not by AI" height=30></a></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js></script><script>pangu.spacingPage()</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=/js/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=/js/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=/css/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=/css/photoswipe.min.css crossorigin=anonymous></main></div><script src=/js/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="/css/local.google.fonts.css",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://npm.elemecdn.com/nprogress@0.2.0/nprogress.js crossorigin=anonymous></script><link rel=stylesheet href=https://npm.elemecdn.com/nprogress@0.2.0/nprogress.css crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>