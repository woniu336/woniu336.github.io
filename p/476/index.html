<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="系统：debian12 使用场景：网站反代 前提：后端站点要配置好证书，绑定域名 域名解析到安装haproxy服务器的ip上 一键脚本 curl -sS -O https://raw.githubusercontent.com/woniu336/open_shell/main/fd-haproxy.sh && chmod +x fd-haproxy.sh && ./fd-haproxy.sh 找一台线路还不错的服务器按照以下方式进行 HAProxy的安装 apt install haproxy -y 安装完毕后，启用haproxy进程 systemctl start haproxy systemctl enable haproxy HAProxy的配置文件地址默认为/etc/haproxy/haproxy.cfg接下来，我们要编辑这个文件， nano /etc/haproxy/haproxy.cfg 配置HAProxy前后端 反代后端站点的80和443端口，仅修改后端服务器ip即可 提示：8.8.8.8为备用服务器（不需要可以注释掉），要做负载均衡，把backup参数移除 global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats socket /run/haproxy/admin.sock mode 660 level admin stats timeout 30s user haproxy group haproxy daemon maxconn 30000 defaults log global mode tcp option tcplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 errorfile 400 /etc/haproxy/errors/400."><title>haproxy的安装与反向代理配置</title>
<link rel=canonical href=https://blog.lufei.de/p/476/><link rel=stylesheet href=/scss/style.min.854e34c0d49cd05dfb69d11f315f89d76adcdf82c7f2d2fc9e8e87cbfc5906f9.css><meta property='og:title' content="haproxy的安装与反向代理配置"><meta property='og:description' content="系统：debian12 使用场景：网站反代 前提：后端站点要配置好证书，绑定域名 域名解析到安装haproxy服务器的ip上 一键脚本 curl -sS -O https://raw.githubusercontent.com/woniu336/open_shell/main/fd-haproxy.sh && chmod +x fd-haproxy.sh && ./fd-haproxy.sh 找一台线路还不错的服务器按照以下方式进行 HAProxy的安装 apt install haproxy -y 安装完毕后，启用haproxy进程 systemctl start haproxy systemctl enable haproxy HAProxy的配置文件地址默认为/etc/haproxy/haproxy.cfg接下来，我们要编辑这个文件， nano /etc/haproxy/haproxy.cfg 配置HAProxy前后端 反代后端站点的80和443端口，仅修改后端服务器ip即可 提示：8.8.8.8为备用服务器（不需要可以注释掉），要做负载均衡，把backup参数移除 global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats socket /run/haproxy/admin.sock mode 660 level admin stats timeout 30s user haproxy group haproxy daemon maxconn 30000 defaults log global mode tcp option tcplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 errorfile 400 /etc/haproxy/errors/400."><meta property='og:url' content='https://blog.lufei.de/p/476/'><meta property='og:site_name' content='路飞博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2025-09-27T12:25:34+08:00'><meta property='article:modified_time' content='2025-10-19T02:36:13+00:00'><meta name=twitter:title content="haproxy的安装与反向代理配置"><meta name=twitter:description content="系统：debian12 使用场景：网站反代 前提：后端站点要配置好证书，绑定域名 域名解析到安装haproxy服务器的ip上 一键脚本 curl -sS -O https://raw.githubusercontent.com/woniu336/open_shell/main/fd-haproxy.sh && chmod +x fd-haproxy.sh && ./fd-haproxy.sh 找一台线路还不错的服务器按照以下方式进行 HAProxy的安装 apt install haproxy -y 安装完毕后，启用haproxy进程 systemctl start haproxy systemctl enable haproxy HAProxy的配置文件地址默认为/etc/haproxy/haproxy.cfg接下来，我们要编辑这个文件， nano /etc/haproxy/haproxy.cfg 配置HAProxy前后端 反代后端站点的80和443端口，仅修改后端服务器ip即可 提示：8.8.8.8为备用服务器（不需要可以注释掉），要做负载均衡，把backup参数移除 global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats socket /run/haproxy/admin.sock mode 660 level admin stats timeout 30s user haproxy group haproxy daemon maxconn 30000 defaults log global mode tcp option tcplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 errorfile 400 /etc/haproxy/errors/400."><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/lxgwwenkaiscreen.css><link rel=stylesheet href=https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css><link rel=stylesheet href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css><style>#scroll-to-top,#search-button{display:none;position:fixed;right:30px;z-index:99;border:none;outline:none;background-color:transparent;color:#555;cursor:pointer;padding:10px;transition:color .3s}#scroll-to-top:hover,#search-button:hover{color:#333}#scroll-to-top{bottom:20px}#search-button{bottom:80px}.cat-icon{width:40px;height:40px}@media(min-width:768px){#search-button{display:none!important}}@media(max-width:767px){#search-button{display:block}}</style><button onclick=topFunction() id=scroll-to-top title=回到顶部>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-square-rounded-arrow-up-filled" width="43" height="43" viewBox="0 0 24 24" stroke-width="1.5" stroke="#597e8d" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 2c-.218.0-.432.002-.642.005l-.616.017-.299.013-.579.034-.553.046c-4.785.464-6.732 2.411-7.196 7.196l-.046.553-.034.579c-.005.098-.01.198-.013.299l-.017.616-.004.318L2 12c0 .218.002.432.005.642l.017.616.013.299.034.579.046.553c.464 4.785 2.411 6.732 7.196 7.196l.553.046.579.034c.098.005.198.01.299.013l.616.017L12 22l.642-.005.616-.017.299-.013.579-.034.553-.046c4.785-.464 6.732-2.411 7.196-7.196l.046-.553.034-.579c.005-.098.01-.198.013-.299l.017-.616L22 12l-.005-.642-.017-.616-.013-.299-.034-.579-.046-.553c-.464-4.785-2.411-6.732-7.196-7.196l-.553-.046-.579-.034a28.058 28.058.0 00-.299-.013l-.616-.017-.318-.004L12 2zm-.148 5.011.058-.007L12 7l.075.003.126.017.111.03.111.044.098.052.104.074.082.073 4 4a1 1 0 01-1.32 1.497l-.094-.083L13 10.415V16a1 1 0 01-1.993.117L11 16v-5.585l-2.293 2.292a1 1 0 01-1.32.083l-.094-.083a1 1 0 01-.083-1.32l.083-.094 4-4a.927.927.0 01.112-.097l.11-.071.114-.054.105-.035.118-.025z" fill="currentcolor" stroke-width="0"/></svg>
</button>
<button onclick=openSearch() id=search-button title=搜索>
<svg width="42" height="42" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="circleClip"><circle cx="18" cy="18" r="16"/></clipPath></defs><rect width="42" height="42" fill="#597e8d" clip-path="url(#circleClip)"/><text x="18" y="22" font-family="Arial, sans-serif" font-size="16" fill="#fff" text-anchor="middle">搜</text></svg>
</button>
<script>window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?(document.getElementById("scroll-to-top").style.display="block",document.getElementById("search-button").style.display="block"):(document.getElementById("scroll-to-top").style.display="none",document.getElementById("search-button").style.display="none")}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}function openSearch(){window.location.href="/search/"}</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","nvdrlerc32")</script><script>window.FPConfig={delay:0,ignoreKeywords:[],maxRPS:3,hoverDelay:50}</script><script defer src=/js/flying-pages.min.js></script></head><body class=article-page><!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Hugo博客公告弹窗</title><style>.announcement-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000}.announcement-popup{background-color:#f3f3ee;border-radius:12px;padding:25px 30px 30px;max-width:80%;width:400px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:relative;overflow:hidden}.announcement-popup::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.8) 0%,rgba(255,255,255,0) 70%);opacity:.7}.announcement-title{font-size:1.5em;margin-bottom:15px;color:#4a4a4a;position:relative}.announcement-content{margin-bottom:25px;color:#666;line-height:1.6;position:relative}.button-container{text-align:right}.announcement-button{background-color:#c4eded;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;transition:all .3s ease;font-weight:700;display:inline-block;min-width:60px}.announcement-button:hover{background-color:silver;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1)}.announcement-button::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.3) 0%,rgba(255,255,255,0) 70%);opacity:0;transition:opacity .3s ease}.announcement-button:hover::after{opacity:1}</style></head><body></body></html><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/logo_hu0c0098ec637fbdee9625c9564bc46fb7_131256_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar referrerpolicy=no-referrer></a></figure><div class=site-meta><h1 class=site-name><a href=/>路飞博客</a></h1><h2 class=site-description>自由自在只做感兴趣的事</h2></div></header><ol class=menu-social><li><a href=https://space.bilibili.com/295463778 target=_blank title=bilibili rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-bilibili" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a></li><li><a href=https://github.com/woniu336 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href='https://github.com/woniu336?tab=repositories/' target=_blank><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-automation"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 20.693c-.905.628-2.36.292-2.675-1.01a1.724 1.724.0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724.0 00-1.065-2.572c-1.756-.426-1.756-2.924.0-3.35a1.724 1.724.0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37 1 .608 2.296.07 2.572-1.065.426-1.756 2.924-1.756 3.35.0a1.724 1.724.0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724.0 001.065 2.572c1.492.362 1.716 2.219.674 3.03"/><path d="M9 12a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17 22l5-3-5-3z"/></svg>
<span>Github</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-axe" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#9e9e9e" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 9l7.383 7.418c.823.82.823 2.148.0 2.967a2.11 2.11.0 01-2.976.0L10 12"/><path d="M6.66 15.66l-3.32-3.32a1.25 1.25.0 01.42-2.044L7 9l6-6 3 3-6 6-1.296 3.24a1.25 1.25.0 01-2.044.42z"/></svg>
<span>资源</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828A4 4 0 109.172 9.172a4 4 0 005.656 5.656z"/><path d="M6.343 17.657l-1.414 1.414"/><path d="M6.343 6.343 4.929 4.929"/><path d="M17.657 6.343l1.414-1.414"/><path d="M17.657 17.657l1.414 1.414"/><path d="M4 12H2"/><path d="M12 4V2"/><path d="M20 12h2"/><path d="M12 20v2"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg>
<span>深色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#haproxy的安装>HAProxy的安装</a></li></ol></li><li><a href=#配置haproxy前后端>配置HAProxy前后端</a><ol><li><a href=#添加安全头>添加安全头</a></li><li><a href=#获取客户端真实ip>获取客户端真实ip</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/476/>haproxy的安装与反向代理配置</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-09-27</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 2 分钟</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#9e9e9e" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4L18.5 9.5a2.828 2.828.0 10-4-4L4 16v4"/><path d="M13.5 6.5l4 4"/></svg>
<time class=article-time--reading>字数: 284字</time></div></footer></div></header><section class=article-content><blockquote><p>系统：debian12</p><p>使用场景：网站反代</p><p>前提：后端站点要配置好证书，绑定域名</p><p>域名解析到安装haproxy服务器的ip上</p></blockquote><p>一键脚本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -sS -O https://raw.githubusercontent.com/woniu336/open_shell/main/fd-haproxy.sh &amp;&amp; chmod +x fd-haproxy.sh &amp;&amp; ./fd-haproxy.sh
</span></span></code></pre></div><p>找一台线路还不错的服务器按照以下方式进行</p><h3 id=haproxy的安装>HAProxy的安装</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apt install haproxy -y
</span></span></code></pre></div><p>安装完毕后，启用haproxy进程</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>systemctl start haproxy
</span></span><span class=line><span class=cl>systemctl enable haproxy
</span></span></code></pre></div><p>HAProxy的配置文件地址默认为<code>/etc/haproxy/haproxy.cfg</code>接下来，我们要编辑这个文件，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>nano /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><h2 id=配置haproxy前后端>配置HAProxy前后端</h2><p>反代后端站点的80和443端口，仅修改后端服务器ip即可</p><p>提示：8.8.8.8为备用服务器（不需要可以注释掉），要做负载均衡，把<code>backup</code>参数移除</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>global</span>
</span></span><span class=line><span class=cl>    <span class=nb>log</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nb>log</span>    <span class=n>local0</span>
</span></span><span class=line><span class=cl>    <span class=nb>log</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nb>log</span>    <span class=n>local1</span> <span class=n>notice</span>
</span></span><span class=line><span class=cl>    <span class=n>chroot</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>haproxy</span>
</span></span><span class=line><span class=cl>    <span class=n>stats</span> <span class=n>socket</span> <span class=o>/</span><span class=n>run</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>admin</span><span class=o>.</span><span class=n>sock</span> <span class=n>mode</span> <span class=mi>660</span> <span class=n>level</span> <span class=n>admin</span>
</span></span><span class=line><span class=cl>    <span class=n>stats</span> <span class=n>timeout</span> <span class=mi>30</span><span class=n>s</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=n>haproxy</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=n>haproxy</span>
</span></span><span class=line><span class=cl>    <span class=n>daemon</span>
</span></span><span class=line><span class=cl>    <span class=n>maxconn</span> <span class=mi>30000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>defaults</span>
</span></span><span class=line><span class=cl>    <span class=nb>log</span>     <span class=n>global</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span>    <span class=n>tcp</span>
</span></span><span class=line><span class=cl>    <span class=n>option</span>  <span class=n>tcplog</span>
</span></span><span class=line><span class=cl>    <span class=n>option</span>  <span class=n>dontlognull</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span> <span class=n>connect</span> <span class=mi>5000</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span> <span class=n>client</span>  <span class=mi>50000</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span> <span class=n>server</span>  <span class=mi>50000</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>400</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>400.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>403</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>403.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>408</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>408.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>500</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>500.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>502</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>502.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>503</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>503.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>errorfile</span> <span class=mi>504</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>errors</span><span class=o>/</span><span class=mf>504.</span><span class=n>http</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># HTTPS重定向frontend (HTTP模式)</span>
</span></span><span class=line><span class=cl><span class=n>frontend</span> <span class=n>http_redirect</span>
</span></span><span class=line><span class=cl>    <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>80</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=n>http</span>
</span></span><span class=line><span class=cl>    <span class=n>option</span> <span class=n>httplog</span>
</span></span><span class=line><span class=cl>    <span class=n>redirect</span> <span class=n>scheme</span> <span class=n>https</span> <span class=n>code</span> <span class=mi>301</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># HTTPS frontend (TCP模式用于SSL透传)</span>
</span></span><span class=line><span class=cl><span class=n>frontend</span> <span class=n>tcp_front_443</span>
</span></span><span class=line><span class=cl>    <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>443</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>    <span class=n>option</span> <span class=n>tcplog</span>
</span></span><span class=line><span class=cl>    <span class=n>rate</span><span class=o>-</span><span class=n>limit</span> <span class=n>sessions</span> <span class=mi>15000</span>
</span></span><span class=line><span class=cl>    <span class=n>default_backend</span> <span class=n>servers_443</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>backend</span> <span class=n>servers_443</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=n>web1</span> <span class=mf>7.7</span><span class=o>.</span><span class=mf>7.7</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>10</span><span class=n>s</span> <span class=n>rise</span> <span class=mi>2</span> <span class=n>fall</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=n>web2</span> <span class=mf>8.8</span><span class=o>.</span><span class=mf>8.8</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>10</span><span class=n>s</span> <span class=n>rise</span> <span class=mi>2</span> <span class=n>fall</span> <span class=mi>3</span> <span class=n>backup</span>
</span></span></code></pre></div><p>验证格式是否正确：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>haproxy -c -f /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><p>重启生效</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>systemctl restart haproxy
</span></span></code></pre></div><p>检查状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>systemctl status haproxy
</span></span></code></pre></div><h3 id=添加安全头>添加安全头</h3><p>可选，在后端站点，例如站点nginx配置中添加以下参数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>add_header</span> <span class=n>Strict</span><span class=o>-</span><span class=n>Transport</span><span class=o>-</span><span class=n>Security</span> <span class=s2>&#34;max-age=31536000; includeSubDomains; preload&#34;</span> <span class=n>always</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>add_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=o>-</span><span class=n>Options</span> <span class=s2>&#34;nosniff&#34;</span> <span class=n>always</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>add_header</span> <span class=n>X</span><span class=o>-</span><span class=n>XSS</span><span class=o>-</span><span class=n>Protection</span> <span class=s2>&#34;1; mode=block&#34;</span> <span class=n>always</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>add_header</span> <span class=n>Referrer</span><span class=o>-</span><span class=n>Policy</span> <span class=s2>&#34;strict-origin-when-cross-origin&#34;</span> <span class=n>always</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=获取客户端真实ip>获取客户端真实ip</h3><p>第一步：haproxy启用PROXY协议v2，例如</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>backend web_servers
</span></span><span class=line><span class=cl>    mode tcp
</span></span><span class=line><span class=cl>    balance roundrobin
</span></span><span class=line><span class=cl>    server web1 192.168.1.100:443 send-proxy-v2
</span></span><span class=line><span class=cl>    # send-proxy-v2 启用PROXY协议v2
</span></span></code></pre></div><p>第二步：修改站点nginx配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir -p /home/wwwroot/lnmp01/vhost/cf_real_ip
</span></span><span class=line><span class=cl>nano /home/wwwroot/lnmp01/vhost/cf_real_ip/cloudflare.conf
</span></span></code></pre></div><p>复制</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Cloudflare IP ranges
</span></span><span class=line><span class=cl># HAProxy IP
</span></span><span class=line><span class=cl>set_real_ip_from 你的HAProxy服务器IP;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Cloudflare IPv4
</span></span><span class=line><span class=cl>set_real_ip_from 173.245.48.0/20;
</span></span><span class=line><span class=cl>set_real_ip_from 103.21.244.0/22;
</span></span><span class=line><span class=cl>set_real_ip_from 103.22.200.0/22;
</span></span><span class=line><span class=cl>set_real_ip_from 103.31.4.0/22;
</span></span><span class=line><span class=cl>set_real_ip_from 141.101.64.0/18;
</span></span><span class=line><span class=cl>set_real_ip_from 108.162.192.0/18;
</span></span><span class=line><span class=cl>set_real_ip_from 190.93.240.0/20;
</span></span><span class=line><span class=cl>set_real_ip_from 188.114.96.0/20;
</span></span><span class=line><span class=cl>set_real_ip_from 197.234.240.0/22;
</span></span><span class=line><span class=cl>set_real_ip_from 198.41.128.0/17;
</span></span><span class=line><span class=cl>set_real_ip_from 162.158.0.0/15;
</span></span><span class=line><span class=cl>set_real_ip_from 104.16.0.0/13;
</span></span><span class=line><span class=cl>set_real_ip_from 104.24.0.0/14;
</span></span><span class=line><span class=cl>set_real_ip_from 172.64.0.0/13;
</span></span><span class=line><span class=cl>set_real_ip_from 131.0.72.0/22;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Cloudflare IPv6
</span></span><span class=line><span class=cl>set_real_ip_from 2400:cb00::/32;
</span></span><span class=line><span class=cl>set_real_ip_from 2606:4700::/32;
</span></span><span class=line><span class=cl>set_real_ip_from 2803:f800::/32;
</span></span><span class=line><span class=cl>set_real_ip_from 2405:b500::/32;
</span></span><span class=line><span class=cl>set_real_ip_from 2405:8100::/32;
</span></span><span class=line><span class=cl>set_real_ip_from 2a06:98c0::/29;
</span></span><span class=line><span class=cl>set_real_ip_from 2c0f:f248::/32;
</span></span></code></pre></div><p>站点配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>listen 443 ssl http2 proxy_protocol;
</span></span><span class=line><span class=cl>include /home/wwwroot/lnmp01/vhost/cf_real_ip/cloudflare.conf;
</span></span><span class=line><span class=cl>real_ip_header proxy_protocol;
</span></span></code></pre></div><p>最后重启nginx生效</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>CC BY-NC-SA 4.0 转载请注明</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2025-10-19 02:36</span></section></footer></article><footer class=site-footer><section class=powerby><a target=_blank title=clarity统计 href=https://clarity.microsoft.com/projects>clarity统计</a><br></section><section class=copyright><br>共手书72.3k字·共 468篇文章</br><span><p>本站已稳定运行
<span id=runningdays class=running-days></span>
<script>function updateRunningTime(){const t=new Date("2023-07-25".replace(/-/g,"/")),n=new Date,e=n-t,s=Math.floor(e/(1e3*60*60*24)),o=Math.floor(e%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(e%(1e3*60*60)/(1e3*60)),a=Math.floor(e%(1e3*60)/1e3),r=`${s} 天 ${o} 小时 ${i} 分 ${a} 秒 `;document.getElementById("runningdays").innerHTML=r}setInterval(updateRunningTime,1e3),updateRunningTime()</script><br></section><a target=_blank href=https://github.com/CaiJimmy/hugo-theme-stack title=主题开源项目><img src=/img/github.svg alt>
</a><a target=_blank href=https://gohugo.io/ title="由 HUGO 驱动"><img src=/img/hugo.svg alt>
</a><a target=_blank href=https://cloudflare.com/ title="由 CF 部署静态"><img src=/img/cloudflare.svg alt></a></footer><script src=/js/pangu.min.js></script><script>pangu.spacingPage()</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=/js/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=/js/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=/css/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=/css/photoswipe.min.css crossorigin=anonymous></main></div><script src=/js/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="/css/local.google.fonts.css",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>